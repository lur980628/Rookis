# ==============================================================================
# stats_view.py - í†µê³„ ì°¨íŠ¸ íƒ­
# ==============================================================================
# ì´ íŒŒì¼ì€ í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ì–‘í•œ í†µê³„ ì°¨íŠ¸ë¥¼ ìƒì„±í•˜ì—¬
# ì‚¬ìš©ìì—ê²Œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ëŠ” í™”ë©´ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
# Plotly Express ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸í„°ë™í‹°ë¸Œí•œ ì°¨íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
#
# [ì£¼ìš” ê¸°ëŠ¥]
# 1. **ë°ì´í„° ì¤€ë¹„:** `app.py`ì—ì„œ ì „ë‹¬ë°›ì€ í•„í„°ë§ëœ ë³´í˜¸ì†Œ ë°ì´í„°
#    (`filtered_data`)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê° ì°¨íŠ¸ì— ë§ëŠ” í˜•íƒœë¡œ ë°ì´í„°ë¥¼ ê°€ê³µ(group by, sum ë“±)í•©ë‹ˆë‹¤.
# 2. **í’ˆì¢…ë³„ ë³´í˜¸ ë™ë¬¼ ìˆ˜ ë§‰ëŒ€ ì°¨íŠ¸:**
#    - ë³´í˜¸ì†Œë³„ë¡œ ì§‘ê³„ëœ ì£¼ìš” í’ˆì¢…(`species`)ê³¼ ë™ë¬¼ ìˆ˜(`count`)ë¥¼ ê·¸ë£¹í™”í•˜ì—¬
#      ì „ì²´ í’ˆì¢…ë³„ ì´ ë™ë¬¼ ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
#    - `px.bar`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë§‰ëŒ€ ì°¨íŠ¸ë¥¼ ìƒì„±í•˜ê³ , ê° ë§‰ëŒ€ì— ìˆ˜ì¹˜ë¥¼ í‘œì‹œí•˜ì—¬
#      ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.
# 3. **ì§€ì—­ë³„ ì¥ê¸° ë³´í˜¸ ë™ë¬¼ ë¹„ìœ¨ íŒŒì´ ì°¨íŠ¸:**
#    - ë³´í˜¸ì†Œ ì£¼ì†Œ(`careAddr`)ì—ì„œ ì‹œ/ë„ ì •ë³´ë§Œ ì¶”ì¶œí•˜ì—¬ ìƒˆë¡œìš´ 'sido' ì»¬ëŸ¼ì„ ë§Œë“­ë‹ˆë‹¤.
#    - ì‹œ/ë„ë³„ë¡œ ì¥ê¸° ë³´í˜¸ ë™ë¬¼ ìˆ˜(`long_term`)ì˜ í•©ê³„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
#    - `px.pie`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§€ì—­ë³„ ì¥ê¸° ë³´í˜¸ ë™ë¬¼ì˜ ë¶„í¬ë¥¼ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆëŠ”
#      íŒŒì´ ì°¨íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
#    - ë‹¨ì¼ ì§€ì—­ë§Œ ì„ íƒëœ ê²½ìš° ë¹„ìœ¨ ë¹„êµê°€ ì˜ë¯¸ ì—†ìœ¼ë¯€ë¡œ, ì°¨íŠ¸ë¥¼ í‘œì‹œí•˜ì§€ ì•Šê³ 
#      ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
# ==============================================================================

import streamlit as st
import plotly.express as px

def show(filtered_data):
    """
    'í†µê³„ ì°¨íŠ¸' íƒ­ì˜ ì „ì²´ UIë¥¼ ê·¸ë¦¬ê³  ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜ì…ë‹ˆë‹¤.

    Args:
        filtered_data (pd.DataFrame): app.pyì—ì„œ í•„í„°ë§ëœ ë³´í˜¸ì†Œ ë°ì´í„°.
    """
    st.subheader("ğŸ“Š í†µê³„ ì°¨íŠ¸")

    # í•„í„°ë§ëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, ê²½ê³  ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
    if filtered_data.empty:
        st.warning("í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„° ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.")
        return

    # --- 1. í’ˆì¢…ë³„ ë³´í˜¸ ë™ë¬¼ ìˆ˜ (ë§‰ëŒ€ ì°¨íŠ¸) ---
    st.markdown("#### í’ˆì¢…ë³„ ë³´í˜¸ ë™ë¬¼ ìˆ˜")
    
    # 'species' ì»¬ëŸ¼ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ê³ , ê° í’ˆì¢…ì˜ 'count'ë¥¼ í•©ì‚°í•©ë‹ˆë‹¤.
    species_chart_data = filtered_data.groupby("species")["count"].sum().reset_index()
    
    # Plotly Expressë¥¼ ì‚¬ìš©í•˜ì—¬ ë§‰ëŒ€ ì°¨íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    fig_bar = px.bar(
        species_chart_data,
        x="species",        # xì¶•: í’ˆì¢…
        y="count",          # yì¶•: ë™ë¬¼ ìˆ˜
        color="species",    # ê° ë§‰ëŒ€ë¥¼ í’ˆì¢…ë³„ë¡œ ë‹¤ë¥¸ ìƒ‰ìœ¼ë¡œ í‘œì‹œ
        text="count",       # ë§‰ëŒ€ ìœ„ì— ìˆ˜ì¹˜(count)ë¥¼ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
        template="plotly_white" # ê¹”ë”í•œ í°ìƒ‰ ë°°ê²½ì˜ í…œí”Œë¦¿ ì‚¬ìš©
    )
    fig_bar.update_traces(textposition="outside") # í…ìŠ¤íŠ¸ë¥¼ ë§‰ëŒ€ ë°”ê¹¥ìª½ì— í‘œì‹œ
    fig_bar.update_layout(showlegend=False, margin=dict(t=10, b=10)) # ë²”ë¡€ëŠ” ìˆ¨ê¸°ê³ , ì°¨íŠ¸ ì—¬ë°±ì„ ì¡°ì ˆ
    st.plotly_chart(fig_bar, use_container_width=True) # Streamlitì— ì°¨íŠ¸ë¥¼ ë Œë”ë§

    # --- 2. ì§€ì—­ë³„ ì¥ê¸° ë³´í˜¸ ë™ë¬¼ ë¹„ìœ¨ (íŒŒì´ ì°¨íŠ¸) ---
    st.markdown("#### ì§€ì—­ë³„ ì¥ê¸° ë³´í˜¸ ë™ë¬¼ ë¹„ìœ¨")
    
    # ì›ë³¸ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì—¬ ì‘ì—…í•©ë‹ˆë‹¤ (ì›ë³¸ ë°ì´í„° ë³´ì¡´).
    chart_data = filtered_data.copy()
    # 'careAddr' ì»¬ëŸ¼ì—ì„œ ì²« ë‹¨ì–´(ì‹œ/ë„)ë¥¼ ì¶”ì¶œí•˜ì—¬ 'sido' ì»¬ëŸ¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
    chart_data['sido'] = chart_data['careAddr'].str.split().str[0]
    
    # ì—¬ëŸ¬ ì§€ì—­ì´ ì„ íƒë˜ì–´ ë¹„êµê°€ ì˜ë¯¸ ìˆì„ ë•Œë§Œ íŒŒì´ ì°¨íŠ¸ë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
    if chart_data['sido'].nunique() > 1:
        # 'sido' ì»¬ëŸ¼ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ê³ , ê° ì§€ì—­ì˜ 'long_term' ìˆ˜ë¥¼ í•©ì‚°í•©ë‹ˆë‹¤.
        long_term_chart_data = chart_data.groupby("sido")["long_term"].sum().reset_index()
        
        # Plotly Expressë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì´ ì°¨íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        fig_pie = px.pie(
            long_term_chart_data,
            values="long_term", # ê° ì¡°ê°ì˜ í¬ê¸°: ì¥ê¸° ë³´í˜¸ ë™ë¬¼ ìˆ˜
            names="sido",      # ê° ì¡°ê°ì˜ ì´ë¦„: ì‹œ/ë„
            template="plotly_white",
            title="ì‹œë„ë³„ ì¥ê¸° ë³´í˜¸ ë™ë¬¼ ë¹„ìœ¨"
        )
        st.plotly_chart(fig_pie, use_container_width=True)
    else:
        # ë‹¨ì¼ ì§€ì—­ë§Œ ì„ íƒë˜ì—ˆì„ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        st.info("ì—¬ëŸ¬ ì§€ì—­ì„ í•¨ê»˜ ì„ íƒí•´ì•¼ ë¹„ìœ¨ ì°¨íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")