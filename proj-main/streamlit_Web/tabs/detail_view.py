# ==============================================================================
# detail_view.py - ë³´í˜¸ì†Œ ìƒì„¸ í˜„í™© íƒ­
# ==============================================================================
# ì´ íŒŒì¼ì€ ì‚¬ìš©ìê°€ ì§€ë„ì—ì„œ íŠ¹ì • ë³´í˜¸ì†Œë¥¼ ì„ íƒí–ˆì„ ë•Œ, í•´ë‹¹ ë³´í˜¸ì†Œì˜
# ìƒì„¸ ì •ë³´ì™€ í˜„ì¬ ë³´í˜¸ ì¤‘ì¸ ë™ë¬¼ë“¤ì˜ ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” í™”ë©´ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
#
# [ì£¼ìš” ê¸°ëŠ¥]
# 1. **ì„ íƒëœ ë³´í˜¸ì†Œ í™•ì¸:** `st.session_state`ì— ì €ì¥ëœ `selected_shelter` ê°’ì„
# Â  Â ê°€ì ¸ì™€ í˜„ì¬ ì–´ë–¤ ë³´í˜¸ì†Œê°€ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
# 2. **ë™ë¬¼ ìƒì„¸ ì •ë³´ ì¡°íšŒ:** `data_manager.get_animal_details` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬
# Â  Â ì„ íƒëœ ë³´í˜¸ì†Œì— ì†Œì†ëœ ë™ë¬¼ë“¤ì˜ ë°ì´í„°ë¥¼ DBì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
# 3. **ë™ë¬¼ ëª©ë¡ í‘œì‹œ:** ì¡°íšŒëœ ë™ë¬¼ ë°ì´í„°ë¥¼ ë°˜ë³µí•˜ë©´ì„œ ê° ë™ë¬¼ì˜ ì‚¬ì§„, ì´ë¦„,
# Â  Â ë‚˜ì´, íŠ¹ì§• ë“±ì˜ ì •ë³´ë¥¼ `st.columns`ë¥¼ í™œìš©í•˜ì—¬ ê¹”ë”í•˜ê²Œ í‘œì‹œí•©ë‹ˆë‹¤.
# 4. **ì°œí•˜ê¸° ê¸°ëŠ¥:** ê° ë™ë¬¼ ì •ë³´ ì˜†ì— 'ì°œí•˜ê¸°/ì°œ ì·¨ì†Œ' ë²„íŠ¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
# Â  Â - ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ `st.session_state.favorites` ëª©ë¡ì— í•´ë‹¹ ë™ë¬¼ì˜
# Â  Â  Â ê³ ìœ  ID(`desertion_no`)ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì œê±°í•©ë‹ˆë‹¤.
# Â  Â - ìƒíƒœ ë³€ê²½ í›„ `st.rerun()`ì„ í˜¸ì¶œí•˜ì—¬ í™”ë©´ì„ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë³€ê²½ì‚¬í•­ì„
# Â  Â  Â ë°˜ì˜í•©ë‹ˆë‹¤.
# 5. **ë°ì´í„° ë‹¤ìš´ë¡œë“œ:** í˜„ì¬ í•„í„°ë§ëœ ì¡°ê±´ì— ë§ëŠ” ë³´í˜¸ì†Œ ëª©ë¡ ì „ì²´ë¥¼
# Â  Â CSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆëŠ” ë²„íŠ¼ì„ ì œê³µí•©ë‹ˆë‹¤.
# ==============================================================================

import streamlit as st
from data_manager import get_animal_details
import pandas as pd
import os # ì¶”ê°€: íŒŒì¼ ê²½ë¡œ í™•ì¸ì„ ìœ„í•´ os ëª¨ë“ˆ import

def show(filtered_data):
    """
    'ë³´í˜¸ì†Œ ìƒì„¸ í˜„í™©' íƒ­ì˜ ì „ì²´ UIë¥¼ ê·¸ë¦¬ê³  ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜ì…ë‹ˆë‹¤.

    Args:
        filtered_data (pd.DataFrame): app.pyì—ì„œ í•„í„°ë§ëœ ë³´í˜¸ì†Œ ë°ì´í„°.
                                     CSV ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
    """
    st.subheader("ğŸ“‹ ë³´í˜¸ì†Œ ìƒì„¸ í˜„í™©")

    # ì„¸ì…˜ ìƒíƒœì—ì„œ ì‚¬ìš©ìê°€ ì§€ë„ì—ì„œ í´ë¦­í•œ ë³´í˜¸ì†Œ ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    selected_shelter = st.session_state.get("selected_shelter", None)

    # ë³´í˜¸ì†Œê°€ ì„ íƒëœ ê²½ìš°ì—ë§Œ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
    if selected_shelter:
        st.markdown(f"### ğŸ  {selected_shelter}")

        # ì„ íƒëœ ë³´í˜¸ì†Œ ì´ë¦„ìœ¼ë¡œ í•´ë‹¹ ë³´í˜¸ì†Œì˜ ë™ë¬¼ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
        animal_details = get_animal_details(selected_shelter)

        if not animal_details.empty:
            # ì¡°íšŒëœ ë™ë¬¼ ëª©ë¡ì„ í•˜ë‚˜ì”© ìˆœíšŒí•˜ë©° í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
            for _, animal in animal_details.iterrows():
                # í™”ë©´ì„ ë‘ ê°œì˜ ì»¬ëŸ¼ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ì™¼ìª½ì€ ì´ë¯¸ì§€, ì˜¤ë¥¸ìª½ì€ í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë°°ì¹˜í•©ë‹ˆë‹¤.
                cols = st.columns([1, 3])
                with cols[0]:
                    # --- ì´ë¯¸ì§€ ë¡œë”© ë¡œì§ ìˆ˜ì • ---
                    image_path = animal.get('image_path')
                    if image_path and os.path.exists(image_path):
                        st.image(image_path, width=150)
                    else:
                        st.image('https://via.placeholder.com/150?text=No+Image', 
                                 width=150)
                    # --- ìˆ˜ì • ë ---
                        
                with cols[1]:
                    # --- ì°œí•˜ê¸° ë²„íŠ¼ ë¡œì§ ---
                    # ê° ë²„íŠ¼ì€ ê³ ìœ í•œ keyë¥¼ ê°€ì ¸ì•¼ í•˜ë¯€ë¡œ, ë™ë¬¼ì˜ ê³ ìœ  ID(desertion_no)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    # desertion_noê°€ ì—†ëŠ” ë°ì´í„°ì˜ ê²½ìš°, ì°œí•˜ê¸° ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
                    if 'desertion_no' in animal and pd.notna(animal['desertion_no']):
                        is_favorited = animal['desertion_no'] in st.session_state.favorites
                        button_text = "â¤ï¸ ì°œ ì·¨ì†Œ" if is_favorited else "ğŸ¤ ì°œí•˜ê¸°"
                        
                        # ë²„íŠ¼ í´ë¦­ ì‹œì˜ ë¡œì§
                        if st.button(button_text, key=f"fav_add_{animal['desertion_no']}"):
                            if is_favorited:
                                st.session_state.favorites.remove(animal['desertion_no'])
                            else:
                                st.session_state.favorites.append(animal['desertion_no'])
                            # í™”ë©´ì„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ ë° ì°œ ëª©ë¡ ìˆ˜ ì—…ë°ì´íŠ¸ë¥¼ ì¦‰ì‹œ ë°˜ì˜í•©ë‹ˆë‹¤.
                            st.rerun()
                    else:
                        st.info("ì°œí•˜ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ìœ ê¸°ë²ˆí˜¸ ì—†ìŒ).")

                    # ë™ë¬¼ì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì˜ˆì˜ê²Œ í‘œì‹œí•©ë‹ˆë‹¤.
                    st.markdown(f"**{animal['animal_name']}** ({animal['species']}, {animal['age']})")
                    st.markdown(f"**ğŸ’– ì„±ê²©:** {animal.get('personality', 'ì •ë³´ ì—†ìŒ')}")
                    st.markdown(f"**ğŸ¾ ë°œê²¬ ì´ì•¼ê¸°:** {animal.get('story', 'ì •ë³´ ì—†ìŒ')}")
                
                st.markdown("---") # ê° ë™ë¬¼ ì •ë³´ ì‚¬ì´ì— êµ¬ë¶„ì„ ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
        else:
            st.warning("ì´ ë³´í˜¸ì†Œì— ë“±ë¡ëœ ë™ë¬¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")

    else:
        # ì•„ì§ ë³´í˜¸ì†Œë¥¼ ì„ íƒí•˜ì§€ ì•Šì€ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
        st.info("ì§€ë„ì—ì„œ ë³´í˜¸ì†Œ ë§ˆì»¤ë¥¼ í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

    st.markdown("---")
    # ì‚¬ìš©ìê°€ í˜„ì¬ í•„í„°ë§ëœ ì¡°ê±´ì˜ ë³´í˜¸ì†Œ ëª©ë¡ì„ íŒŒì¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
    st.download_button(
        label="ğŸ“¥ í˜„ì¬ í•„í„°ë§ëœ ë³´í˜¸ì†Œ ëª©ë¡ ë‹¤ìš´ë¡œë“œ (CSV)",
        data=filtered_data.to_csv(index=False).encode('utf-8-sig'), # í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•´ 'utf-8-sig' ì¸ì½”ë”© ì‚¬ìš©
        file_name="filtered_shelter_data.csv",
        mime="text/csv"
    )